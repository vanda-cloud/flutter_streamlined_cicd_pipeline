name: Flutter Â» Streamlined CI/CD Pipeline
run-name: ${{ github.actor }} is publishing (${{ github.ref_name }}) ðŸš€

on:
  push:
    workflow_dispatch:
    pull_request:
    branches:
      - dev
      - production
jobs:
  analyze:
    name: Build and Analyze
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'adopt'
          java-version: '17.x'

      - name: Cache Flutter SDK
        id: cache-flutter
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.2' # specify the correct version

      - name: Clean Flutter project
        run: flutter clean

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

      # - name: Archive Flutter SDK
      #   # if: steps.cache-flutter.outputs.cache-hit != 'true'
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: flutter-sdk
      #     path: ~/.pub-cache

      - name: Build Android
        run: flutter build apk --debug --split-per-abi

  # test:
  #   name: 4 Automated Tests
  #   runs-on: macos-latest
  #   needs: analyze    
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v3

  #     - name: Download Flutter SDK
  #       uses: actions/download-artifact@v3
  #       with:
  #         name: flutter-sdk # Ensure this matches the name used in upload-artifact above
  #         path: ~/.pub-cache

  #     - name: Set up Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.22.2' # specify the correct version

  #     - name: Run tests
  #       run: flutter test

  # build-android:
  #   name: Build Android
  #   runs-on: macos-latest
  #   needs: test
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v3

  #     - name: Download Flutter SDK
  #       uses: actions/download-artifact@v3
  #       with:
  #         name: flutter-sdk # Ensure this matches the name used in upload-artifact above
  #         path: ~/.pub-cache

  #     - name: Set up Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.22.2' # specify the correct version

  #     - name: Build Android
  #       run: flutter build apk --debug --split-per-abi

  # build-ios:
  #   name: Build iOS
  #   runs-on: macos-latest
  #   needs: build-android
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v3

  #     - name: Download Flutter SDK
  #       uses: actions/download-artifact@v3
  #       with:
  #         name: flutter-sdk # Ensure this matches the name used in upload-artifact above
  #         path: ~/.pub-cache

  #     - name: Set up Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.22.2' # specify the correct version

  #     - run: |
  #         flutter build ios --no-codesign
  #         cd build/ios/iphoneos
  #         mkdir Payload
  #         cd Payload
  #         ln -s ../Runner.app
  #         cd ..
  #         zip -r app.ipa Payload

  # release:
  #   name: Release Apps
  #   runs-on: macos-latest
  #   needs: build-ios
  #   steps:
  #     - name: Push to Releases
  #       uses: ncipollo/release-action@v1
  #       with:
  #         artifacts: "build/app/outputs/apk/debug/*,build/ios/iphoneos/app.ipa"
  #         tag: v1.0.${{ github.run_number }}
  #         token: ${{ secrets.RELEASE_TOKEN }}